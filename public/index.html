<head>
    <title>Doodle!</title>
    <style>
        /* Fill the screen, and use a small border at the edges */
        body {
            height: 100vh;
            margin: 0;
            padding: 5px;
            box-sizing: border-box;
        }
        /* Make the image as big as possible without warping */
        img {
            height: 100%;
            width: 100%;
            object-fit: contain;
            object-position: left top;
            image-rendering: pixelated;
        }
    </style>
    <script>
        const image = new Image();

        {
            // swap the HTML-based img for our generated Image.
            // this gives us control over reloading it on updates from the server
            if (document.readyState !== "loading") onloadingdone();
            else document.addEventListener("readystatechange", onloadingdone, { once: true });
            function onloadingdone() {
                document.querySelector("img").replaceWith(image)
            }
        }

        fetch_canvas();
        function fetch_canvas() {
            image.src = "/api/canvas?version=" + performance.now();
        }
        // Subscribe to all updates to the canvas and reload it whenever they happen
        new EventSource("/api/subscribe-updates").onmessage = fetch_canvas;

        let last_x = -1;
        let last_y = -1;
        image.addEventListener("mousedown", function(ev) {
            ev.preventDefault();
            
            const image = ev.target;
            let xratio = ev.offsetX / image.clientWidth;
            let yratio = ev.offsetY / image.clientHeight;
            const imageRatio = image.naturalWidth / image.naturalHeight;
            const elRatio = image.clientWidth / image.clientHeight;
            if (imageRatio < elRatio) {
                xratio *= elRatio / imageRatio;
            } else {
                yratio *= imageRatio / elRatio;
            }
            {
                const x = Math.floor(xratio * image.naturalWidth);
                const y = Math.floor(yratio * image.naturalHeight);
                if (last_x === x && last_y === y) return;
                fetch(`/api/set/${x}/${y}/red`, { method: "POST" });
                last_x = x;
                last_y = y;
            }
        });
    </script>
</head>
<!-- browsers will typically cache this image, meaning they won't see the most recent canvas without JavaScript enabled -->
<img src="/api/canvas?version=0"/>